// IndiePair Form Script v1.1
(function() {
  'use strict';
  
  var app = document.getElementById('indiepair-app');
  var currentStep = 'role';
  var currentRole = null;
  
  // HTML Templates
  var templates = {
    role: '<div><h3 class="ip-heading">ğŸ‘‹ Welcome to IndiePair!</h3><p class="ip-subtext">This takes 2 minutes. We\'ll match you with your perfect profit-share partner.</p><p class="ip-question">Are you a...</p><div class="ip-roles"><button type="button" class="ip-role-btn" data-role="developer"><span class="ip-icon">ğŸ’»</span><span class="ip-title">Developer</span><span class="ip-subtitle">(looking for marketer)</span></button><button type="button" class="ip-role-btn" data-role="marketer"><span class="ip-icon">ğŸ“ˆ</span><span class="ip-title">Marketer</span><span class="ip-subtitle">(looking for developer)</span></button></div></div>',
    
    developer: '<div><button type="button" class="ip-back">â† Back</button><h3 class="ip-heading">Developer Application</h3><form id="ip-form"><div class="ip-group"><input type="text" name="name" class="ip-input" placeholder="Your Name" required></div><div class="ip-group"><input type="email" name="email" class="ip-input" placeholder="Email Address" required></div><div class="ip-group"><input type="text" name="twitter_handle" class="ip-input" placeholder="Twitter/X Handle (e.g., @yourhandle)" required></div><div class="ip-group"><textarea name="product" class="ip-input ip-textarea" placeholder="What product are you building? (2-3 sentences)" rows="4" required></textarea></div><div class="ip-group"><select name="stage" class="ip-input ip-select" required><option value="" disabled selected>What stage are you at?</option><option value="idea">Idea stage (not built yet)</option><option value="mvp-no-users">Built MVP, no users</option><option value="users-no-revenue">Have users, no revenue</option><option value="1-1k-mrr">$1-$1K MRR</option><option value="1k-10k-mrr">$1K-$10K MRR</option><option value="10k-plus-mrr">$10K+ MRR</option></select></div><div class="ip-group"><select name="marketing_need" class="ip-input ip-select" required><option value="" disabled selected>What marketing help do you need most?</option><option value="seo-content">SEO & content marketing</option><option value="paid-ads">Paid ads (Google/Facebook)</option><option value="social-media">Social media growth</option><option value="email-marketing">Email marketing & automation</option><option value="product-launch">Product Hunt / launch strategy</option><option value="all">All of the above</option></select></div><div class="ip-group"><select name="profit_share" class="ip-input ip-select" required><option value="" disabled selected>What % of profit are you willing to share?</option><option value="20-30">20-30%</option><option value="30-40">30-40%</option><option value="40-50">40-50%</option><option value="negotiable">Negotiable</option></select></div><button type="submit" class="ip-submit">Submit Application â†’</button></form></div>',
    
    marketer: '<div><button type="button" class="ip-back">â† Back</button><h3 class="ip-heading">Marketer Application</h3><form id="ip-form"><div class="ip-group"><input type="text" name="name" class="ip-input" placeholder="Your Name" required></div><div class="ip-group"><input type="email" name="email" class="ip-input" placeholder="Email Address" required></div><div class="ip-group"><input type="text" name="twitter_handle" class="ip-input" placeholder="Twitter/X Handle (e.g., @yourhandle)" required></div><div class="ip-group"><textarea name="experience" class="ip-input ip-textarea" placeholder="What\'s your marketing background? (2-3 sentences - past results, specialties)" rows="4" required></textarea></div><div class="ip-group"><label class="ip-check-label">Core Marketing Skills (select all that apply)</label><div class="ip-checks"><label class="ip-check-item"><input type="checkbox" name="skills" value="seo-content"><span class="ip-check-box"></span><span class="ip-check-text">SEO & content marketing</span></label><label class="ip-check-item"><input type="checkbox" name="skills" value="paid-ads"><span class="ip-check-box"></span><span class="ip-check-text">Paid ads (Google/Facebook/LinkedIn)</span></label><label class="ip-check-item"><input type="checkbox" name="skills" value="social-media"><span class="ip-check-box"></span><span class="ip-check-text">Social media growth</span></label><label class="ip-check-item"><input type="checkbox" name="skills" value="email-marketing"><span class="ip-check-box"></span><span class="ip-check-text">Email marketing & automation</span></label><label class="ip-check-item"><input type="checkbox" name="skills" value="product-launches"><span class="ip-check-box"></span><span class="ip-check-text">Product launches (Product Hunt, etc.)</span></label><label class="ip-check-item"><input type="checkbox" name="skills" value="community"><span class="ip-check-box"></span><span class="ip-check-text">Community building</span></label><label class="ip-check-item"><input type="checkbox" name="skills" value="analytics"><span class="ip-check-box"></span><span class="ip-check-text">Analytics & optimization</span></label></div></div><div class="ip-group"><input type="url" name="portfolio" class="ip-input" placeholder="Portfolio, case studies, or LinkedIn URL" required></div><div class="ip-group"><textarea name="ideal_product" class="ip-input ip-textarea" placeholder="What type of product do you want to market? (Industry, stage, B2B/B2C, etc.)" rows="4" required></textarea></div><button type="submit" class="ip-submit">Submit Application â†’</button></form></div>',
    
    loading: '<div class="ip-loading"><div class="ip-spinner"></div><p class="ip-loading-text">Submitting your application...</p></div>',
    
    success: '<div class="ip-success"><div class="ip-success-icon">ğŸ‰</div><h3 class="ip-success-title">You\'re in!</h3><p class="ip-success-text">We\'ll review your application and reach out within 48 hours if you\'re a good fit for our founding member beta.</p><div class="ip-success-footer"><p>Follow us: <a href="https://twitter.com/amd_saad" target="_blank" class="ip-link">@amd_saad</a></p></div></div>'
  };
  
  function render(step) {
    currentStep = step;
    app.innerHTML = templates[step];
    attachListeners();
  }
  
  function attachListeners() {
    var roleButtons = app.querySelectorAll('[data-role]');
    for (var i = 0; i < roleButtons.length; i++) {
      roleButtons[i].addEventListener('click', handleRoleClick);
    }
    
    var backBtn = app.querySelector('.ip-back');
    if (backBtn) {
      backBtn.addEventListener('click', function() {
        render('role');
      });
    }
    
    var form = app.querySelector('#ip-form');
    if (form) {
      form.addEventListener('submit', handleSubmit);
    }
  }
  
  function handleRoleClick(e) {
    currentRole = e.currentTarget.getAttribute('data-role');
    render(currentRole);
  }
  
  function handleSubmit(e) {
    e.preventDefault();
    
    var form = e.target;
    var formData = new FormData(form);
    
    var data = {
      role: currentRole,
      name: formData.get('name'),
      email: formData.get('email'),
      twitter_handle: formData.get('twitter_handle'),
      status: 'new'
    };
    
    if (currentRole === 'developer') {
      data.product_or_experience = formData.get('product');
      data.stage_or_skills = formData.get('stage');
      data.what_they_need = formData.get('marketing_need');
      data.profit_share_percent = formData.get('profit_share');
    } else {
      data.product_or_experience = formData.get('experience');
      var skills = formData.getAll('skills');
      if (skills.length === 0) {
        alert('Please select at least one marketing skill');
        return;
      }
      data.stage_or_skills = skills.join(', ');
      data.portfolio_link = formData.get('portfolio');
      data.ideal_product = formData.get('ideal_product');
    }
    
    render('loading');
    
    var config = window.IP_CONFIG;
    fetch(config.url + '/rest/v1/applications', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'apikey': config.key,
        'Authorization': 'Bearer ' + config.key,
        'Prefer': 'return=minimal'
      },
      body: JSON.stringify(data)
    }).then(function(response) {
      if (response.ok || response.status === 201) {
        render('success');
      } else {
        throw new Error('Submission failed');
      }
    }).catch(function(error) {
      alert('Something went wrong. Please try again or contact @amd_saad on Twitter');
      console.error('Error:', error);
      render(currentRole);
    });
  }
  
  // Initialize
  render('role');
})();